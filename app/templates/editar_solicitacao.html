{% extends "base.html" %}
{% block extra_styles %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/buttons.css') }}">
{% endblock %}

{% block content %}
<div class="container-fluid py-4" style="max-width: 1200px;">

    {# --- Cabeçalho Dinâmico --- #}
    <div class="d-flex align-items-center mb-3">
       <h2 class="text-dark m-0">
           <i class="bi bi-pencil-square me-2 text-primary"></i> 
           {% if is_admin %}Edição Completa (Administrador){% else %}Corrigir Solicitação{% endif %}
       </h2>
    </div>

    {# --- Alerta Condicional --- #}
    {% if is_admin %}
    <div class="alert alert-danger shadow-sm rounded-4 mb-4" role="alert">
        <div class="d-flex align-items-center">
            <i class="bi bi-exclamation-triangle-fill fs-4 me-3"></i>
            <div>
                <strong>Atenção Admin:</strong> Você está editando os dados originais. Alterações aqui são diretas e imediatas.
            </div>
        </div>
    </div>
    {% elif pedido.status == 'NEGADO' %}
    <div class="alert alert-warning shadow-sm rounded-4 mb-4" role="alert">
        <div class="d-flex align-items-center">
            <i class="bi bi-info-circle-fill fs-4 me-3"></i>
            <div>
                <strong>Ajuste Necessário:</strong> Edite os campos abaixo para reenviar sua solicitação para análise.
            </div>
        </div>
    </div>
    {% endif %}

    <div class="card info status-primary shadow-sm rounded-4 border-0">
        <div class="card-body p-4">
            
            {# Rota genérica atualizada #}
            <form action="{{ url_for('main.editar_solicitacao', id=pedido.id) }}" method="POST">
                
                <h5 class="text-secondary mb-4 small fw-bold text-uppercase border-bottom pb-2">
                    Pedido #{{ pedido.id }} - {{ pedido.usuario.nome_uvis }}
                </h5>

                {# --- SEÇÃO 1: DATA E OPERAÇÃO --- #}
                <div class="d-flex align-items-center mb-3">
                    <i class="bi bi-calendar-event text-primary me-2 fs-5"></i>
                    <h5 class="m-0 text-primary fw-bold">Data e Operação</h5>
                </div>

                <div class="row g-3 mb-4">
                    <div class="col-md-4">
                        <label class="form-label fw-bold small text-muted">Data da Visita</label>
                        <input type="date" class="form-control" name="data_agendamento" 
                               value="{{ pedido.data_agendamento.isoformat() if pedido.data_agendamento else '' }}" required>
                    </div>

                    <div class="col-md-3">
                        <label class="form-label fw-bold small text-muted">Horário</label>
                        <input type="time" class="form-control" name="hora_agendamento" 
                               value="{{ pedido.hora_agendamento.strftime('%H:%M') if pedido.hora_agendamento else '' }}" required>
                    </div>

                    <div class="col-md-5">
                        <label class="form-label fw-bold small text-muted">Foco Principal</label>
                        <select name="foco" class="form-select" required>
                            {% set focos = ['Imóvel Abandonado', 'Piscina / Caixa D\'água', 'Terreno Baldio', 'Ponto Estratégico (PE)'] %}
                            {% for foco_opcao in focos %}
                                <option value="{{ foco_opcao }}" {% if pedido.foco == foco_opcao %}selected{% endif %}>{{ foco_opcao }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <hr class="text-muted opacity-25 my-4">

                {# --- SEÇÃO 2: DETALHES OPERACIONAIS --- #}
                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <label class="form-label fw-bold small text-muted">Tipo de Visita</label>
                        <select name="tipo_visita" class="form-select">
                            <option value="Monitoramento" {% if pedido.tipo_visita == 'Monitoramento' %}selected{% endif %}>Monitoramento</option>
                            <option value="Aedes" {% if pedido.tipo_visita == 'Aedes' %}selected{% endif %}>Aedes</option>
                            <option value="Culex" {% if pedido.tipo_visita == 'Culex' %}selected{% endif %}>Culex</option>
                        </select>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label fw-bold small text-muted">Altura Máxima</label>
                        <select name="altura_voo" class="form-select">
                            {% for h in ['10m', '20m', '30m', '40m'] %}
                                <option value="{{ h }}" {% if pedido.altura_voo == h %}selected{% endif %}>{{ h }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="row mb-3 p-3 rounded mx-1 border">
                    <label class="fw-bold d-block mb-2 text-muted small">Necessário Apoio CET?</label>
                    <div class="d-flex gap-4">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="apoio_cet" id="cetSim" value="sim" {% if pedido.apoio_cet %}checked{% endif %}>
                            <label class="form-check-label" for="cetSim">Sim</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="apoio_cet" id="cetNao" value="nao" {% if not pedido.apoio_cet %}checked{% endif %}>
                            <label class="form-check-label" for="cetNao">Não</label>
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="form-label fw-bold small text-muted">Observações da UVIS</label>
                    <textarea class="form-control" name="observacao" rows="2">{{ pedido.observacao or '' }}</textarea>
                </div>

                <hr class="text-muted opacity-25 my-4">

                {# --- SEÇÃO 3: LOCALIZAÇÃO --- #}
                <div class="row g-3 mb-3">
                    <div class="col-md-3">
                        <label class="form-label fw-bold small text-muted">CEP</label>
                        <input type="text" class="form-control" id="cep" name="cep" value="{{ pedido.cep or '' }}" required>
                    </div>
                    <div class="col-md-7">
                        <label class="form-label fw-bold small text-muted">Logradouro</label>
                        <input type="text" class="form-control" id="logradouro" name="logradouro" value="{{ pedido.logradouro or '' }}" required>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-bold small text-muted">Número</label>
                        <input type="text" class="form-control" id="numero" name="numero" value="{{ pedido.numero or '' }}">
                    </div>
                </div>

                <div class="row g-3 mb-4">
                    <div class="col-md-5">
                        <label class="form-label fw-bold small text-muted">Bairro</label>
                        <input type="text" class="form-control" id="bairro" name="bairro" value="{{ pedido.bairro or '' }}" required>
                    </div>
                    <div class="col-md-5">
                        <label class="form-label fw-bold small text-muted">Cidade</label>
                        <input type="text" class="form-control" id="cidade" name="cidade" value="{{ pedido.cidade or '' }}" required>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-bold small text-muted">UF</label>
                        <input type="text" class="form-control" id="uf" name="uf" value="{{ pedido.uf or '' }}" maxlength="2" required>
                    </div>
                </div>

                {# --- SEÇÃO 4: STATUS (PROTEGIDA) --- #}
                {% if is_admin %}
                <hr class="text-muted opacity-25 my-4">
                <div class="d-flex align-items-center mb-3">
                    <i class="bi bi-shield-lock-fill text-primary me-2 fs-5"></i>
                    <h5 class="m-0 text-primary fw-bold">Controle Interno (Apenas Admin)</h5>
                </div>

                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <label class="form-label fw-bold small text-muted">Protocolo DECEA</label>
                        <input name="protocolo" class="form-control font-monospace" placeholder="BR-2025-XXXX" value="{{ pedido.protocolo or '' }}">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold small text-muted">Status Atual</label>
                        <select name="status" class="form-select fw-semibold">
                            {% for opt in ["PENDENTE", "EM ANÁLISE", "APROVADO", "APROVADO COM RECOMENDAÇÕES", "NEGADO"] %}
                                <option value="{{ opt }}" {% if pedido.status == opt %}selected{% endif %}>{{ opt }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-12">
                        <label class="form-label fw-bold small text-muted">Justificativa ou Recomendações</label>
                        <input name="justificativa" class="form-control" value="{{ pedido.justificativa or '' }}">
                    </div>
                </div>
                {% endif %}

                {# BOTÕES #}
                <div class="d-flex justify-content-end gap-2 mt-5">
                    <a href="{{ url_for('main.admin_dashboard' if is_admin else 'main.dashboard') }}" class="btn btn-outline-danger px-4">
                        <i class="bi bi-x-lg me-1"></i> Cancelar
                    </a>
                    <button type="submit" class="btn btn-primary px-4 shadow-sm fw-bold">
                        <i class="bi bi-check-lg me-1"></i> {% if is_admin %}Salvar Alterações{% else %}Reenviar para Análise{% endif %}
                    </button>
                </div>

            </form>
        </div>
    </div>
</div>
{% endblock %}

{# O seu Script de CEP permanece o mesmo, ele já é funcional para ambos #}

{% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function() {
      const cepInput = document.getElementById("cep");

      if (cepInput) {
          cepInput.addEventListener("keyup", function () {
            let val = this.value.replace(/\D/g, "");

            if (val.length === 8) {
                // Adiciona classe de loading
                this.classList.add('loading-spinner');
                this.disabled = true;

                // Limpa campos para evitar dados residuais
                document.getElementById("logradouro").value = "";
                document.getElementById("bairro").value = "";
                document.getElementById("cidade").value = "";
                document.getElementById("uf").value = "";
                
                // MUDANÇA AQUI: Agora chama a SUA rota do Flask
                fetch(`/api/cep/${val}`)
                    .then((response) => response.json())
                    .then((data) => {
                        this.classList.remove('loading-spinner');
                        this.disabled = false;
                        this.focus();
                        
                        // Ajustado para a lógica da sua API Python (data.ok)
                        if (data.ok) {
                            document.getElementById("logradouro").value = data.logradouro || "";
                            document.getElementById("bairro").value = data.bairro || "";
                            document.getElementById("cidade").value = data.cidade || "";
                            document.getElementById("uf").value = data.uf || "";
                            
                            // Foca no número
                            document.getElementById("numero").focus();
                        } else {
                            // Erro retornado pela sua API (CEP não encontrado ou inválido)
                            if(typeof Swal !== 'undefined'){
                                Swal.fire({
                                    toast: true,
                                    position: 'top-end',
                                    icon: 'warning',
                                    title: data.error || 'CEP não encontrado.',
                                    showConfirmButton: false,
                                    timer: 3000,
                                    customClass: {
                                        popup: document.body.classList.contains('dark-mode') ? 'swal2-dark-mode' : ''
                                    }
                                });
                            }
                        }
                    })
                    .catch((err) => {
                        this.classList.remove('loading-spinner');
                        this.disabled = false;
                        console.error("Falha na consulta de CEP:", err);
                    });
            }
          });
      }

      // Inicialização dos Tooltips (para o botão de ajuda nos negados)
      var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
      var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
      })
  });
</script>

{# Inclua aqui o restante do seu script do Chatbot que você já tem #}
{% endblock %}